name: Build and Deploy Documentation to Azure App Service

#on:
 # workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'biomni-app-host'  # This is the only variable we need now

jobs:
  build-and-deploy-docs:
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout all project files'
      uses: actions/checkout@v3

    # Step 1: Build the image. This runs all setup scripts AND the 'make html' command
    # This step will take a long time, just like before.
    - name: 'Build the documentation builder image'
      run: docker build . -f Dockerfile.base -t doc-builder

    # Step 2: Create a temporary folder to hold the finished website
    - name: 'Create a folder for the deployable files'
      run: mkdir -p deploy_folder

    # Step 3: Extract the finished 'build/html' folder from inside the image
    - name: 'Extract documentation from the builder image'
      run: |
        docker create --name extractor doc-builder
        docker cp extractor:/app/build/html/. ./deploy_folder
        docker rm extractor

    # Step 4: Login to Azure (this stays the same)
    - name: 'Login to Azure'
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Step 5: Deploy the FOLDER of static files to the App Service
    - name: 'Deploy Static Files to Azure App Service'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        # This is the critical change that tells it to deploy files, not a container
        package: 'deploy_folder'
